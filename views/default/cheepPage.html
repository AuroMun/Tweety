<link rel="stylesheet" href="{{=URL('static','css/bootstrap.min.css')}}"/>
<link rel="stylesheet" href="{{=URL('static', 'css/custom.css')}}"/>
<link rel="stylesheet" href="{{=URL('static','css/web2py-bootstrap4.css')}}"/>

<script>
  function fillModal(parent, a){
    //document.getElementById("replyCheeps"+a).innerHTML = "THIS IS A TEST"
    var form = new FormData();
    form.append("parent", parent);

    var settings = {
      "async": true,
      "crossDomain": true,
      "url": "{{=URL('replies')}}",
      "method": "POST",
      "processData": false,
      "contentType": false,
      "mimeType": "multipart/form-data",
      "data": form
    }

    $.ajax(settings).done(function (response) {
      console.log(response);
      document.getElementById("replyCheeps"+a).innerHTML = response;
    });
  }

    function likeCheep(cheepId, a){
    //document.getElementById("replyCheeps"+a).innerHTML = "THIS IS A TEST"
    var form = new FormData();
    form.append("cheepId", cheepId);

    var settings = {
      "async": true,
      "crossDomain": true,
      "url": "{{=URL('like')}}",
      "method": "POST",
      "processData": false,
      "contentType": false,
      "mimeType": "multipart/form-data",
      "data": form
    }

    $.ajax(settings).done(function (response) {
      console.log(response);
      n = parseInt(document.getElementById("likeButton"+a).innerHTML.trim().split(" ")[1]);

      document.getElementById("likeButton"+a).innerHTML = "Like " + (n+parseInt(response));
    });
  }

  function deleteCheep(cheepId){
  //document.getElementById("replyCheeps"+a).innerHTML = "THIS IS A TEST"
  var form = new FormData();
  form.append("cheepId", cheepId);

  var settings = {
    "async": true,
    "crossDomain": true,
    "url": "{{=URL('deleteCheep')}}",
    "method": "POST",
    "processData": false,
    "contentType": false,
    "mimeType": "multipart/form-data",
    "data": form
  }

  $.ajax(settings).done(function (response) {
    console.log(response);
    window.location = "{{=URL('notifs')}}";
  });
}

function render(cheepBody){
  var res = cheepBody.split(" ");
  var parsed = '';
  for(i=0;i<res.length;i++){
    if(res[i][0]=='#'){
      parsed+=' <a href="http://127.0.0.1:8000/Tweety/default/search?name=';
      parsed+=res[i].substring(1,res[i].length)
      parsed+= '">';
      parsed+=res[i];
      parsed+='</a> ';
      //res[i].substring(1,res[i].length)
    }
    else parsed+=res[i];
    parsed+=' ';
  }
  document.write(parsed);
}

function recheepButton(cheepId){
    //document.getElementById("replyCheeps"+a).innerHTML = "THIS IS A TEST"
    var form = new FormData();
    form.append("cheepId", cheepId);

    var settings = {
      "async": true,
      "crossDomain": true,
      "url": "{{=URL('recheep')}}",
      "method": "POST",
      "processData": false,
      "contentType": false,
      "mimeType": "multipart/form-data",
      "data": form
    }

    $.ajax(settings).done(function (response) {
      console.log(response);
    window.location = "{{=URL('home')}}";
    });
  }

 </script>

{{a=cheep_id}}
<div class="cheepWrapper">
<img class="avatar" src={{=URL('default/download', cheep.author.picture)}}/>
     <span class="name">{{=(cheep.author.first_name)}}</span> @{{=cheep.author.handle}}
     {{if cheep.author != cheep.orig_author: }}
         <span>| Recheep from @{{=cheep.orig_author.handle}}</span>
     {{pass}}

     {{if cheep.author==auth.user.id:}}
     <img style="width:10px; height=10px; float:right; margin: 10px 19px 0;" onclick="deleteCheep({{=cheep.id}})" src={{=URL('static','cross.png')}}/>
     {{pass}}

     <p>
          {{=cheep.body}}
     </p>
      <span class="time" style="padding-left:30px;"> on {{=cheep.tstamp}} </span>
     <button type="button" class="btn btn-primary" id="likeButton{{=a}}" onclick="likeCheep({{=cheep.id}}, {{=a}})">
 Like {{=cheep.likes}}

</button>
<button type="button" class="btn btn-primary"  onclick="recheepButton({{=cheep.id}})" >
    Recheep
  </button>
<form enctype="multipart/form-data" action={{=URL('reply')}} method="post"> Reply: <input name="body" /> <input name="parent" type="hidden" value={{=cheep.id}} /> <input name="author" type="hidden" value={{=auth.user.id}} /><input type="submit" />
</form>

{{for cheep in replies:}}
<div class="cheepWrapper">
<img class="avatar" src={{=URL('default/download', cheep.cheeps.author.picture)}}/>
        <span class="name">{{=(cheep.cheeps.author.first_name)}}</span> @{{=cheep.cheeps.author.handle}}
        {{if cheep.cheeps.author==auth.user.id:}}
        <img style="width:10px; height=10px; float:right; margin: 10px 19px 0;" onclick="deleteCheep({{=cheep.cheeps.id}})" src={{=URL('static','cross.png')}}/>
        {{pass}}
        <p>
            {{=cheep.cheeps.body}}
        </p>
         <span class="time" style="padding-left:30px;"> on {{=cheep.cheeps.tstamp}} </span>
        <button type="button" class="btn btn-primary" id="likeButton{{=cheep.cheeps.id}}" onclick="likeCheep({{=cheep.cheeps.id}}, {{=cheep.cheeps.id}})">
              Like {{=cheep.cheeps.likes}}
        </button>
        <button type="button" class="btn btn-primary"  onclick="recheepButton({{=cheep.cheeps.id}})" >Recheep</button>

</div>
{{pass}}
